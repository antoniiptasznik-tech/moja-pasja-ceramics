---
import Layout from "../../layouts/Layout.astro";
import Navigation from "../../components/Navigation.astro";
import Newsletter from "../../components/Newsletter.astro";
import Button from "../../components/Button.astro";
import { getCollection, getEntry } from "astro:content";
import AddToCart from "../../components/AddToCart";

const { id } = Astro.params;

if (!id) {
   return Astro.redirect("/404");
}

const productEntry = await getEntry("products", id);

if (!productEntry) {
   return Astro.redirect("/404");
}

const product = productEntry.data;
const products = (await getCollection("products")).sort(
   (a, b) => (a.data.sequence || 0) - (b.data.sequence || 0),
);
---

<Layout>
   <main class="bg-navy-900 min-h-screen">
      <Navigation />

      <section class="pt-32 pb-24 px-6 max-w-7xl mx-auto">
         <div class="grid md:grid-cols-2 gap-12 md:gap-24 items-start">
            {/* Left Column: Gallery */}
            <div class="space-y-6">
               <div class="relative aspect-[4/5] overflow-hidden bg-white/5">
                  <img
                     src={product.images[0]}
                     alt={product.name}
                     transition:name={`image-${id}`}
                     class={`w-full h-full object-cover ${!product.isAvailable ? "grayscale opacity-80" : ""}`}
                  />
                  {
                     !product.isAvailable && (
                        <div class="absolute inset-0 bg-navy-900/40 backdrop-blur-[2px] flex items-center justify-center">
                           <span class="border border-white/30 px-6 py-2 text-cream-100 text-xs tracking-widest uppercase bg-navy-900/60">
                              Wyprzedane
                           </span>
                        </div>
                     )
                  }
               </div>
               <div class="grid grid-cols-4 gap-4">
                  {
                     product.images.map((img, i) => (
                        <div
                           class={`aspect-square overflow-hidden cursor-pointer border border-white/10 hover:border-bronze-500 transition-colors ${i === 0 ? "ring-1 ring-bronze-500" : ""}`}
                        >
                           <img
                              src={img}
                              alt=""
                              class="w-full h-full object-cover opacity-80 hover:opacity-100 transition-opacity"
                           />
                        </div>
                     ))
                  }
               </div>
            </div>

            {/* Right Column: Details */}
            <div class="space-y-10 pt-4 md:pt-12 sticky top-32">
               <div class="space-y-4 border-b border-white/10 pb-8">
                  <span
                     class="text-bronze-500 uppercase tracking-widest text-xs font-serif"
                     >{product.category}</span
                  >
                  <h1
                     class="text-4xl md:text-5xl font-serif text-cream-100"
                     transition:name={`title-${id}`}
                  >
                     {product.name}
                  </h1>
                  <p class="text-2xl font-light text-cream-100/90">
                     {product.price}
                  </p>
               </div>

               <div class="space-y-6">
                  <div class="prose text-gray-400 mb-8">
                     <p>{product.description}</p>
                  </div>

                  <div class="space-y-4 mb-8">
                     <div
                        class="flex justify-between border-b border-white/10 pb-2"
                     >
                        <span
                           class="text-cream-100/60 uppercase text-xs tracking-widest"
                           >Wymiary</span
                        >
                        <span class="text-cream-100 font-serif"
                           >{product.dimensions}</span
                        >
                     </div>
                     <div
                        class="flex justify-between border-b border-white/10 pb-2"
                     >
                        <span
                           class="text-cream-100/60 uppercase text-xs tracking-widest"
                           >Pielęgnacja</span
                        >
                        <span class="text-cream-100 font-serif"
                           >{product.care}</span
                        >
                     </div>
                  </div>

                  <AddToCart
                     client:load
                     id={id}
                     name={product.name}
                     price={product.price}
                     image={product.images[0]}
                     isAvailable={product.isAvailable}
                  />

                  <p
                     class="text-center text-white/20 text-xs mt-4 uppercase tracking-widest"
                  >
                     {
                        product.delay && product.delay !== "0"
                           ? product.delay
                           : "Wysyłka w 2-3 dni robocze"
                     }
                  </p>
               </div>
            </div>
         </div>
      </section>

      {/* Related Products Logic */}
      <section class="py-24 border-t border-white/5">
         <div class="max-w-7xl mx-auto px-6">
            <h2 class="text-3xl font-serif text-cream-100 mb-12 text-center">
               Zobacz także
            </h2>
            <div class="grid md:grid-cols-3 gap-8 md:gap-12">
               {
                  products
                     .filter((p) => p.id !== id)
                     .slice(0, 3)
                     .map((p) => (
                        <a
                           href={`/produkt/${p.id}`}
                           class="group cursor-pointer block"
                        >
                           <div class="relative aspect-[4/5] overflow-hidden mb-6">
                              <div class="absolute inset-0 bg-navy-900/0 group-hover:bg-navy-900/20 transition-colors duration-500 z-10" />
                              <img
                                 src={p.data.images[0]}
                                 alt={p.data.name}
                                 transition:name={`image-${p.id}`}
                                 class={`w-full h-full object-cover filter brightness-90 group-hover:scale-105 group-hover:brightness-100 transition-all duration-700 ease-out ${!p.data.isAvailable ? "grayscale opacity-60" : ""}`}
                              />

                              {/* Hover CTA */}
                              <div class="absolute bottom-12 left-0 right-0 text-center opacity-0 translate-y-4 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-500 z-20">
                                 <span class="inline-block px-6 py-2 border border-white/30 text-cream-100 text-xs tracking-widest uppercase bg-navy-900/30 backdrop-blur-md">
                                    {p.data.isAvailable
                                       ? "Zobacz Detal"
                                       : "Wyprzedane"}
                                 </span>
                              </div>
                           </div>
                           <div class="text-center space-y-2">
                              <h3
                                 class="text-2xl text-cream-100 font-serif group-hover:text-bronze-500 transition-colors duration-300"
                                 transition:name={`title-${p.id}`}
                              >
                                 {p.data.name}
                              </h3>
                              <p class="text-white/40 font-body text-xs mt-1 uppercase tracking-widest">
                                 {p.data.category} • {p.data.price}
                              </p>
                           </div>
                        </a>
                     ))
               }
            </div>
         </div>
      </section>

      <Newsletter />

      <footer
         class="bg-navy-900 border-t border-white/5 py-16 px-6 text-center"
      >
         <h2 class="text-3xl font-serif text-cream-100 mb-6">
            Aleksandra Ptasznik
         </h2>
         <div
            class="flex justify-center gap-8 mb-8 text-sm tracking-widest uppercase text-cream-100/60 font-serif"
         >
            <a href="#" class="hover:text-bronze-500 transition-colors"
               >Instagram</a
            >
            <a href="/kontakt" class="hover:text-bronze-500 transition-colors"
               >Kontakt</a
            >
            <a href="#" class="hover:text-bronze-500 transition-colors"
               >Regulamin</a
            >
         </div>
         <p class="text-white/20 font-body text-sm">
            © 2026 Ptasznik Ceramics. Rękodzieło z duszą.
         </p>
      </footer>
   </main>
</Layout>
